<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title></title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#1ea7ff}
    body{font-family:Tahoma, Arial, Helvetica, sans-serif;background:var(--bg);color:#e6eef8;margin:0;padding:16px}
    .container{max-width:1100px;margin:8px auto}
    header{display:flex;align-items:center;gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.6)}
    label{display:block;margin:6px 0;font-size:14px;color:var(--muted)}
    select,input,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .small{width:auto;display:inline-block}
    .row{display:flex;gap:8px}
    .btn{background:var(--accent);border:none;color:#06253b;padding:10px 14px;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .configs-list{margin-top:12px}
    .config-item{border:1px dashed rgba(255,255,255,0.04);padding:10px;border-radius:8px;margin-bottom:8px}
    .expired{opacity:0.55}
    .status{font-weight:700}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:12px 0}
    .kbd{background:#08111a;border-radius:6px;padding:4px 8px;font-size:12px}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h2>پنل WireGuard / DNS — نسخه کامل</h2>
      <div class="muted">خوش آمدید</div>
    </header>

    <div class="card">
      <h3>ساخت کانفیگ WireGuard</h3>
      <div class="grid">
        <div>
          <label>کشور</label>
          <select id="countrySelect"></select>
        </div>

        <div>
          <label>اپراتور</label>
          <select id="operatorSelect">
            <option value="auto">انتخاب خودکار</option>
            <option value="mtn">MTN</option>
            <option value="irancell">Irancell</option>
            <option value="hamrah">Hamrah Aval</option>
            <option value="rt">Rightel</option>
          </select>
        </div>

        <div>
          <label>DNS</label>
          <select id="dnsSelect">
            <option value="178.22.122.100,185.51.200.2">Shekan</option>
            <option value="78.157.42.100,78.157.42.101">Electro</option>
            <option value="10.202.10.202,10.202.10.102">RadarGame</option>
          </select>
        </div>

        <div>
          <label>نوع کانفیگ</label>
          <select id="profileType">
            <option value="normal">Normal</option>
            <option value="fast">Fast</option>
            <option value="gaming">Gaming</option>
          </select>
        </div>

        <div>
          <label>درصد ریجستر تیر</label>
          <select id="registerPercent"></select>
        </div>

        <div>
          <label>درصد ایم اسیست</label>
          <select id="massistPercent"></select>
        </div>

        <div>
          <label>مدت زمان (روز)</label>
          <select id="durationDays">
            <option value="30">30</option>
            <option value="60">60</option>
            <option value="90">90</option>
            <option value="180">180</option>
            <option value="365">365</option>
          </select>
        </div>

        <div>
          <label>نام فایل خروجی</label>
          <input id="fileName" type="text" placeholder="wg-USER.conf"/>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="generateAndroidBtn" class="btn">تولید Android</button>
        <button id="generateIosBtn" class="btn">تولید iOS</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>لیست کانفیگ‌ها</h3>
      <div id="configsList" class="configs-list"></div>
    </div>

    <footer class="card"><div>نسخه کامل با ۶۰ کشور + DNS ایرانی — مشکل انتخاب کشور رفع شد</div></footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    /***** کمک‌افزار: تولید کلید Base64 44-char *****/
    function sampleKey(){
      const arr = new Uint8Array(32);
      crypto.getRandomValues(arr);
      let binary = '';
      for(let i=0;i<arr.length;i++){ binary += String.fromCharCode(arr[i]); }
      return btoa(binary); // برای 32 بایت => 44 کاراکتر Base64
    }

    // ۶۰ کشور (code + name) — نمایش به‌صورت "نام — کد"
    const countries = [
      {code:'US',name:'United States'},{code:'GB',name:'United Kingdom'},{code:'DE',name:'Germany'},{code:'FR',name:'France'},
      {code:'NL',name:'Netherlands'},{code:'SE',name:'Sweden'},{code:'NO',name:'Norway'},{code:'FI',name:'Finland'},
      {code:'DK',name:'Denmark'},{code:'CA',name:'Canada'},{code:'AU',name:'Australia'},{code:'NZ',name:'New Zealand'},
      {code:'BE',name:'Belgium'},{code:'AT',name:'Austria'},{code:'IT',name:'Italy'},{code:'ES',name:'Spain'},
      {code:'PT',name:'Portugal'},{code:'PL',name:'Poland'},{code:'CZ',name:'Czechia'},{code:'HU',name:'Hungary'},
      {code:'GR',name:'Greece'},{code:'RO',name:'Romania'},{code:'BG',name:'Bulgaria'},{code:'HR',name:'Croatia'},
      {code:'RS',name:'Serbia'},{code:'UA',name:'Ukraine'},{code:'RU',name:'Russia'},{code:'JP',name:'Japan'},
      {code:'KR',name:'South Korea'},{code:'SG',name:'Singapore'},{code:'AE',name:'UAE'},{code:'TR',name:'Turkey'},
      {code:'QA',name:'Qatar'},{code:'SA',name:'Saudi Arabia'},{code:'IL',name:'Israel'},{code:'OM',name:'Oman'},
      {code:'KW',name:'Kuwait'},{code:'CH',name:'Switzerland'},{code:'IE',name:'Ireland'},{code:'BR',name:'Brazil'},
      {code:'AR',name:'Argentina'},{code:'CL',name:'Chile'},{code:'MX',name:'Mexico'},{code:'CO',name:'Colombia'},
      {code:'PE',name:'Peru'},{code:'ZA',name:'South Africa'},{code:'EG',name:'Egypt'},{code:'NG',name:'Nigeria'},
      {code:'KE',name:'Kenya'},{code:'MA',name:'Morocco'},{code:'DZ',name:'Algeria'},{code:'TN',name:'Tunisia'},
      {code:'IN',name:'India'},{code:'PK',name:'Pakistan'},{code:'BD',name:'Bangladesh'},{code:'VN',name:'Vietnam'}
    ];

    // المان‌ها
    const countrySelect = document.getElementById('countrySelect');
    const operatorSelect = document.getElementById('operatorSelect');
    const dnsSelect = document.getElementById('dnsSelect');
    const profileType = document.getElementById('profileType');
    const registerPercent = document.getElementById('registerPercent');
    const massistPercent = document.getElementById('massistPercent');
    const durationDays = document.getElementById('durationDays');
    const fileNameInput = document.getElementById('fileName');
    const configsList = document.getElementById('configsList');
    const generateAndroidBtn = document.getElementById('generateAndroidBtn');
    const generateIosBtn = document.getElementById('generateIosBtn');

    // پر کردن کشورها
    function populateCountries(){
      countrySelect.innerHTML = '';
      countries.forEach(c=>{
        const o = document.createElement('option');
        o.value = c.code;
        o.textContent = `${c.name} — ${c.code}`;
        countrySelect.appendChild(o);
      });
      // انتخاب پیش‌فرض: اولین کشور
      if(countrySelect.options.length>0) countrySelect.selectedIndex = 0;
    }

    // پر کردن درصدها (10..100 step 10)
    function populatePercents(){
      registerPercent.innerHTML = '';
      massistPercent.innerHTML = '';
      for(let i=10;i<=100;i+=10){
        const o1=document.createElement('option'); o1.value=i; o1.textContent=i+'%';
        const o2=document.createElement('option'); o2.value=i; o2.textContent=i+'%';
        registerPercent.appendChild(o1); massistPercent.appendChild(o2);
      }
      registerPercent.selectedIndex = 0;
      massistPercent.selectedIndex = 0;
    }

    // localStorage key
    const STORAGE_KEY = 'wg_cfgs';

    // unique id
    function uid(){return Math.random().toString(36).slice(2,10);}

    // create config (platform: 'Android'|'iOS')
    function createConfig(platform){
      // اعتبارسنجی ورودی‌ها
      if(!countrySelect.value){
        alert('لطفاً یک کشور انتخاب کنید.');
        return;
      }
      if(!operatorSelect.value){
        alert('لطفاً یک اپراتور انتخاب کنید.');
        return;
      }
      // گرفتن مقادیر فرم
      const country = countrySelect.value;
      const operator = operatorSelect.value;
      const dns = dnsSelect.value;
      const profile = profileType.value;
      const regPercent = registerPercent.value;
      const massist = massistPercent.value;
      const days = parseInt(durationDays.value)||30;
      const fname = (fileNameInput.value && fileNameInput.value.trim()) ? fileNameInput.value.trim() : `wg-${country}-${Date.now()}.conf`;

      const id = uid();
      const createdAt = Date.now();
      const expiresAt = createdAt + days*24*3600*1000;

      // تولید کلیدهای mock (طول صحیح Base64)
      const privateKey = sampleKey();
      const publicKey = sampleKey();
      const preshared = sampleKey();

      const mtu = (platform === 'iOS') ? 1400 : 1420;
      const address = `10.10.${Math.floor(Math.random()*254)+1}.${Math.floor(Math.random()*254)+1}/32`;

      // ساخت متن کانفیگ — شامل متادیتا (کامنت) که درصدها و اپراتور را دارد
      const confText = `[Interface]
# owner=local
# country=${country}
# operator=${operator}
# profile=${profile}
# registerPercent=${regPercent}
# massistPercent=${massist}
# expires=${new Date(expiresAt).toISOString()}
PrivateKey = ${privateKey}
Address = ${address}
DNS = ${dns}
MTU = ${mtu}

[Peer]
PublicKey = ${publicKey}
PresharedKey = ${preshared}
Endpoint = ${country.toLowerCase()}.wg.example.com:51820
AllowedIPs = 0.0.0.0/0, ::/0
PersistentKeepalive = 25
`;

      // ذخیره در localStorage
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      list.unshift({
        id, platform, country, operator, dns, profile,
        registerPercent: regPercent, massistPercent: massist,
        createdAt, expiresAt, fileName: fname, configText: confText
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));

      renderConfigs();
      alert(`کانفیگ (${platform}) برای ${country} ساخته شد.`);
    }

    // دانلود فایل
    function downloadConf(id){
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const it = list.find(x=>x.id===id);
      if(!it){ alert('کانفیگ پیدا نشد'); return; }
      const blob = new Blob([it.configText], {type: 'text/plain;charset=utf-8'});
      saveAs(blob, it.fileName);
    }

    // حذف
    function deleteConf(id){
      if(!confirm('آیا مطمئن هستید حذف شود؟')) return;
      let list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      list = list.filter(x=>x.id!==id);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      renderConfigs();
    }

    // رندر لیست کانفیگ‌ها
    function renderConfigs(){
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      configsList.innerHTML = '';
      if(list.length === 0){
        configsList.innerHTML = '<div class="muted">هیچ کانفیگی تولید نشده</div>';
        return;
      }
      list.forEach(item=>{
        const el = document.createElement('div');
        el.className = 'config-item';
        const expireDate = new Date(item.expiresAt).toLocaleDateString();
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${item.fileName}</strong><div class="muted">${item.platform} — ${item.country}</div></div>
            <div style="text-align:left">
              <div class="muted">اپراتور: ${item.operator}</div>
              <div class="muted">رجیستر: ${item.registerPercent}% — ایم‌اسیست: ${item.massistPercent}%</div>
              <div class="muted">انقضا: ${expireDate}</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn downloadBtn" data-id="${item.id}">دانلود .conf</button>
            <button class="btn" style="background:#ef4444" data-action="delete" data-id="${item.id}">حذف</button>
          </div>
        `;
        configsList.appendChild(el);
      });

      // attach handlers
      document.querySelectorAll('.downloadBtn').forEach(b=>b.addEventListener('click', e=>{
        const id = e.currentTarget.dataset.id; downloadConf(id);
      }));
      document.querySelectorAll('button[data-action="delete"]').forEach(b=>b.addEventListener('click', e=>{
        const id = e.currentTarget.dataset.id; deleteConf(id);
      }));
    }

    // bind دکمه‌ها
    generateAndroidBtn.addEventListener('click', ()=>createConfig('Android'));
    generateIosBtn.addEventListener('click', ()=>createConfig('iOS'));

    // اجرای اولیه
    populateCountries();
    populatePercents();
    renderConfigs();
  </script>
</body>
</html>
